<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CuisineNFC ‚Äì Gestionnaire de cuisine</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f5f0e8;
    --surface: #fdfaf4;
    --surface2: #eee8d8;
    --green: #3a6b4a;
    --green-light: #5a9a6a;
    --green-pale: #d4e8da;
    --amber: #c8832a;
    --amber-pale: #faecd4;
    --red: #c0392b;
    --red-pale: #fde8e6;
    --text: #2c2416;
    --text-muted: #7a6e5e;
    --border: #d8cfc0;
    --shadow: 0 4px 24px rgba(44,36,22,0.08);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }
  /* NOISE TEXTURE */
  body::before {
    content: '';
    position: fixed; inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none; z-index: 0;
  }
  /* HEADER */
  header {
    background: var(--green);
    color: white;
    padding: 0 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 64px;
    position: sticky; top: 0; z-index: 100;
    box-shadow: 0 2px 12px rgba(0,0,0,0.15);
  }
  header h1 {
    font-family: 'Playfair Display', serif;
    font-size: 1.4rem;
    letter-spacing: 0.02em;
  }
  header h1 span { color: #a8d4b2; }
  .nfc-btn {
    background: white;
    color: var(--green);
    border: none;
    padding: 8px 18px;
    border-radius: 24px;
    font-family: 'DM Sans', sans-serif;
    font-weight: 500;
    font-size: 0.85rem;
    cursor: pointer;
    display: flex; align-items: center; gap: 6px;
    transition: all 0.2s;
  }
  .nfc-btn:hover { background: var(--green-pale); }
  .nfc-icon { font-size: 1rem; }
  /* NAV */
  nav {
    display: flex;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 0 24px;
    gap: 0;
    position: sticky; top: 64px; z-index: 99;
  }
  nav button {
    background: none; border: none;
    padding: 14px 20px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--text-muted);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
  }
  nav button.active {
    color: var(--green);
    border-bottom-color: var(--green);
  }
  /* MAIN */
  main { padding: 24px; max-width: 900px; margin: 0 auto; }
  /* TABS */
  .tab { display: none; }
  .tab.active { display: block; }
  /* STATS ROW */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 12px;
    margin-bottom: 28px;
  }
  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 18px;
    text-align: center;
    box-shadow: var(--shadow);
    transition: transform 0.2s;
  }
  .stat-card:hover { transform: translateY(-2px); }
  .stat-card .number {
    font-family: 'Playfair Display', serif;
    font-size: 2rem;
    font-weight: 700;
    color: var(--green);
  }
  .stat-card .label {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 2px;
  }
  .stat-card.warning .number { color: var(--amber); }
  .stat-card.danger .number { color: var(--red); }
  /* SECTION TITLE */
  .section-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.1rem;
    margin-bottom: 14px;
    color: var(--text);
    display: flex; align-items: center; justify-content: space-between;
  }
  .add-btn {
    background: var(--green);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-family: 'DM Sans', sans-serif;
    cursor: pointer;
    display: flex; align-items: center; gap: 4px;
    transition: background 0.2s;
  }
  .add-btn:hover { background: var(--green-light); }
  /* FILTER BAR */
  .filter-bar {
    display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;
  }
  .filter-bar input {
    flex: 1; min-width: 160px;
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 8px 16px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.85rem;
    background: var(--surface);
    outline: none;
    transition: border-color 0.2s;
  }
  .filter-bar input:focus { border-color: var(--green); }
  .filter-chip {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 6px 14px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  .filter-chip.active { background: var(--green-pale); border-color: var(--green); color: var(--green); }
  /* FOOD GRID */
  .food-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: 14px;
  }
  .food-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 16px;
    box-shadow: var(--shadow);
    transition: transform 0.2s, box-shadow 0.2s;
    position: relative;
    overflow: hidden;
  }
  .food-card:hover { transform: translateY(-3px); box-shadow: 0 8px 32px rgba(44,36,22,0.12); }
  .food-card::before {
    content: '';
    position: absolute; top: 0; left: 0; right: 0; height: 4px;
    background: var(--green);
  }
  .food-card.expiring::before { background: var(--amber); }
  .food-card.expired::before { background: var(--red); }
  .food-card-header {
    display: flex; justify-content: space-between; align-items: flex-start;
    margin-bottom: 10px;
  }
  .food-emoji { font-size: 2rem; line-height: 1; }
  .food-actions { display: flex; gap: 4px; }
  .icon-btn {
    background: var(--surface2);
    border: none;
    width: 28px; height: 28px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.8rem;
    display: flex; align-items: center; justify-content: center;
    transition: background 0.2s;
  }
  .icon-btn:hover { background: var(--border); }
  .food-name {
    font-family: 'Playfair Display', serif;
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 4px;
  }
  .food-category {
    font-size: 0.72rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.06em;
    margin-bottom: 10px;
  }
  .food-meta { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
  .badge {
    font-size: 0.72rem;
    padding: 3px 10px;
    border-radius: 12px;
    font-weight: 500;
  }
  .badge-qty { background: var(--green-pale); color: var(--green); }
  .badge-ok { background: var(--green-pale); color: var(--green); }
  .badge-expiring { background: var(--amber-pale); color: var(--amber); }
  .badge-expired { background: var(--red-pale); color: var(--red); }
  .nfc-tag {
    font-size: 0.7rem;
    color: var(--text-muted);
    display: flex; align-items: center; gap: 4px;
  }
  /* ALERT SECTION */
  .alerts-section { margin-bottom: 28px; }
  .alert-item {
    background: var(--amber-pale);
    border: 1px solid #e8c070;
    border-radius: 12px;
    padding: 12px 16px;
    margin-bottom: 8px;
    display: flex; align-items: center; gap: 12px;
    font-size: 0.85rem;
  }
  .alert-item.expired {
    background: var(--red-pale);
    border-color: #e8a0a0;
  }
  .alert-icon { font-size: 1.2rem; }
  .alert-text { flex: 1; }
  .alert-text strong { display: block; margin-bottom: 2px; }
  .alert-text span { color: var(--text-muted); font-size: 0.78rem; }
  /* SHOPPING LIST */
  .shopping-item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 12px 16px;
    margin-bottom: 8px;
    display: flex; align-items: center; gap: 12px;
  }
  .shopping-item input[type=checkbox] { accent-color: var(--green); width: 18px; height: 18px; cursor: pointer; }
  .shopping-item label { flex: 1; font-size: 0.9rem; cursor: pointer; }
  .shopping-item.done label { text-decoration: line-through; color: var(--text-muted); }
  .shopping-qty { font-size: 0.8rem; color: var(--text-muted); }
  .shopping-actions { display: flex; gap: 8px; margin-bottom: 16px; }
  /* HISTORY */
  .history-item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px 16px;
    margin-bottom: 8px;
    display: flex; align-items: center; gap: 12px;
    font-size: 0.85rem;
  }
  .history-date {
    font-size: 0.75rem;
    color: var(--text-muted);
    min-width: 90px;
  }
  .history-action {
    flex: 1;
  }
  .history-badge {
    font-size: 0.72rem; padding: 2px 8px; border-radius: 10px;
  }
  .h-scan { background: #e0f0ff; color: #2060a0; }
  .h-add { background: var(--green-pale); color: var(--green); }
  .h-consume { background: #f0e8ff; color: #6040a0; }
  .h-expire { background: var(--red-pale); color: var(--red); }
  /* MODAL */
  .modal-overlay {
    display: none;
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.4);
    z-index: 200;
    align-items: center; justify-content: center;
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--surface);
    border-radius: 20px;
    padding: 28px;
    width: 90%; max-width: 460px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    animation: slideUp 0.3s ease;
  }
  @keyframes slideUp {
    from { transform: translateY(30px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
  .modal h2 {
    font-family: 'Playfair Display', serif;
    font-size: 1.2rem;
    margin-bottom: 20px;
  }
  .form-group { margin-bottom: 14px; }
  .form-group label { display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 4px; }
  .form-group input, .form-group select, .form-group textarea {
    width: 100%;
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px 14px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.9rem;
    background: var(--bg);
    outline: none;
    transition: border-color 0.2s;
  }
  .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--green); }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .modal-actions { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }
  .btn-primary {
    background: var(--green);
    color: white;
    border: none;
    padding: 10px 24px;
    border-radius: 20px;
    font-family: 'DM Sans', sans-serif;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
  }
  .btn-primary:hover { background: var(--green-light); }
  .btn-secondary {
    background: var(--surface2);
    color: var(--text);
    border: none;
    padding: 10px 20px;
    border-radius: 20px;
    font-family: 'DM Sans', sans-serif;
    cursor: pointer;
    transition: background 0.2s;
  }
  .btn-secondary:hover { background: var(--border); }
  /* NFC SCAN ANIMATION */
  .nfc-scan-modal .nfc-animation {
    text-align: center;
    padding: 30px 0;
  }
  .nfc-ring {
    width: 80px; height: 80px;
    border: 3px solid var(--green);
    border-radius: 50%;
    margin: 0 auto 16px;
    position: relative;
    animation: pulse 1.5s infinite;
  }
  .nfc-ring::before {
    content: '';
    position: absolute;
    inset: 8px;
    border: 3px solid var(--green-light);
    border-radius: 50%;
    animation: pulse 1.5s 0.3s infinite;
  }
  .nfc-ring::after {
    content: 'üì°';
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    font-size: 1.4rem;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(1.1); }
  }
  /* RECIPE SECTION */
  .recipe-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 18px;
    margin-bottom: 12px;
    box-shadow: var(--shadow);
  }
  .recipe-card h3 {
    font-family: 'Playfair Display', serif;
    font-size: 1rem;
    margin-bottom: 8px;
  }
  .recipe-ingredients { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; }
  .ingredient-tag {
    font-size: 0.75rem;
    padding: 3px 10px;
    border-radius: 12px;
    background: var(--green-pale);
    color: var(--green);
  }
  .ingredient-tag.missing {
    background: var(--red-pale);
    color: var(--red);
  }
  .recipe-btn {
    font-size: 0.8rem;
    padding: 6px 14px;
    border-radius: 16px;
    border: 1px solid var(--green);
    background: none;
    color: var(--green);
    cursor: pointer;
    transition: all 0.2s;
  }
  .recipe-btn:hover { background: var(--green); color: white; }
  /* NUTRITION INFO */
  .nutrition-grid {
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 8px;
  }
  .nutrition-cell {
    text-align: center;
    background: var(--bg);
    border-radius: 10px;
    padding: 8px;
  }
  .nutrition-cell .val { font-weight: 600; font-size: 0.9rem; }
  .nutrition-cell .lbl { font-size: 0.65rem; color: var(--text-muted); }
  /* BARCODE */
  .barcode-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 9px 14px;
    font-size: 0.82rem;
    font-family: 'DM Sans', sans-serif;
    cursor: pointer;
    display: flex; align-items: center; gap: 6px;
    transition: all 0.2s;
    width: 100%; justify-content: center;
    margin-bottom: 10px;
  }
  .barcode-btn:hover { border-color: var(--green); color: var(--green); background: var(--green-pale); }
  #barcode-reader { width: 100%; border-radius: 10px; overflow: hidden; margin-bottom: 10px; display: none; }
  #barcode-reader video { width: 100% !important; border-radius: 10px; }
  .barcode-result-box {
    background: #e8f0ff; border: 1px solid #6090d0; border-radius: 10px;
    padding: 10px 14px; font-size: 0.82rem; color: #2060a0;
    margin-bottom: 14px; display: none; animation: fadeIn 0.3s;
  }
  .barcode-result-box strong { display: block; margin-bottom: 4px; }
  /* PHOTO SCAN */
  .photo-scan-area {
    border: 2px dashed var(--border);
    border-radius: 12px;
    padding: 16px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: var(--bg);
    margin-bottom: 14px;
  }
  .photo-scan-area:hover { border-color: var(--green); background: var(--green-pale); }
  .photo-scan-area.scanning { border-color: var(--green); background: var(--green-pale); }
  .photo-preview {
    width: 100%; max-height: 140px; object-fit: cover;
    border-radius: 8px; margin-bottom: 8px; display: none;
  }
  .photo-scan-label { font-size: 0.85rem; color: var(--text-muted); }
  .photo-scan-label span { font-size: 1.4rem; display: block; margin-bottom: 4px; }
  .ai-result-box {
    background: var(--green-pale);
    border: 1px solid var(--green);
    border-radius: 10px;
    padding: 10px 14px;
    font-size: 0.82rem;
    color: var(--green);
    margin-bottom: 14px;
    display: none;
    animation: fadeIn 0.3s;
  }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(-6px); } to { opacity: 1; transform: translateY(0); } }
  .ai-result-box strong { display: block; margin-bottom: 4px; }
  .scanning-spinner {
    display: none;
    text-align: center;
    padding: 8px;
    font-size: 0.82rem;
    color: var(--green);
  }
  /* TOAST */
  .toast {
    position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(100px);
    background: var(--text);
    color: white;
    padding: 12px 24px;
    border-radius: 24px;
    font-size: 0.85rem;
    z-index: 999;
    transition: transform 0.3s;
    white-space: nowrap;
  }
  .toast.show { transform: translateX(-50%) translateY(0); }
  @media (max-width: 500px) {
    nav button { padding: 12px 10px; font-size: 0.75rem; }
    .stats-row { grid-template-columns: repeat(2, 1fr); }
    .form-row { grid-template-columns: 1fr; }
  }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
</head>
<body>

<header>
  <h1>Cuisine<span>NFC</span></h1>
  <button class="nfc-btn" onclick="openNfcScan()">
    <span class="nfc-icon">üì°</span> Scanner NFC
  </button>
</header>

<nav>
  <button class="active" onclick="switchTab('inventaire', this)">ü•ï Inventaire</button>
  <button onclick="switchTab('alertes', this)">‚ö†Ô∏è Alertes</button>
  <button onclick="switchTab('courses', this)">üõí Courses</button>
  <button onclick="switchTab('recettes', this)">üë®‚Äçüç≥ Recettes</button>
  <button onclick="switchTab('historique', this)">üìã Historique</button>
</nav>

<main>

  <!-- INVENTAIRE -->
  <div id="tab-inventaire" class="tab active">
    <div class="stats-row" id="stats-row"></div>
    <div class="section-title">
      <span>Mes aliments</span>
      <button class="add-btn" onclick="openAddModal()">+ Ajouter</button>
    </div>
    <div class="filter-bar">
      <input type="text" id="search-input" placeholder="Rechercher un aliment‚Ä¶" oninput="renderInventaire()">
      <button class="filter-chip active" onclick="setFilter('all', this)">Tout</button>
      <button class="filter-chip" onclick="setFilter('frigo', this)">‚ùÑÔ∏è Frigo</button>
      <button class="filter-chip" onclick="setFilter('placard', this)">üö™ Placard</button>
      <button class="filter-chip" onclick="setFilter('congelateur', this)">üßä Cong√©lo</button>
    </div>
    <div class="food-grid" id="food-grid"></div>
  </div>

  <!-- ALERTES -->
  <div id="tab-alertes" class="tab">
    <div class="section-title">Alertes de p√©remption</div>
    <div id="alerts-list"></div>
  </div>

  <!-- COURSES -->
  <div id="tab-courses" class="tab">
    <div class="section-title">
      <span>Liste de courses</span>
      <button class="add-btn" onclick="openAddCourse()">+ Ajouter</button>
    </div>
    <div class="shopping-actions">
      <button class="btn-secondary" style="font-size:0.8rem;padding:8px 14px;" onclick="autoFillShopping()">ü§ñ Remplissage auto</button>
      <button class="btn-secondary" style="font-size:0.8rem;padding:8px 14px;" onclick="clearDone()">üóëÔ∏è Supprimer coch√©s</button>
    </div>
    <div id="shopping-list"></div>
  </div>

  <!-- RECETTES -->
  <div id="tab-recettes" class="tab">
    <div class="section-title">Recettes sugg√©r√©es</div>
    <p style="font-size:0.85rem;color:var(--text-muted);margin-bottom:16px;">Bas√©es sur votre inventaire actuel ‚ú®</p>
    <div id="recipes-list"></div>
  </div>

  <!-- HISTORIQUE -->
  <div id="tab-historique" class="tab">
    <div class="section-title">Historique des actions</div>
    <div id="history-list"></div>
  </div>

</main>

<!-- MODAL AJOUTER/MODIFIER -->
<div class="modal-overlay" id="food-modal">
  <div class="modal">
    <h2 id="modal-title">Ajouter un aliment</h2>

    <!-- BARCODE SCANNER -->
    <button class="barcode-btn" onclick="toggleBarcodeScanner()">
      <span>üì∑</span> Scanner le code-barres
    </button>
    <div id="barcode-reader"></div>
    <div class="barcode-result-box" id="barcode-result-box">
      <strong>üîç Produit trouv√© !</strong>
      <span id="barcode-result-text"></span>
    </div>

    <!-- PHOTO SCAN ZONE -->
    <div class="photo-scan-area" onclick="document.getElementById('photo-input').click()" id="photo-scan-area">
      <img id="photo-preview" class="photo-preview" alt="Aper√ßu √©tiquette">
      <div class="photo-scan-label">
        <span>üì∑</span>
        Photographier l'√©tiquette pour d√©tecter la date automatiquement
      </div>
    </div>
    <input type="file" id="photo-input" accept="image/*" capture="environment" style="display:none" onchange="handlePhotoUpload(event)">
    <div class="scanning-spinner" id="scanning-spinner">ü§ñ Analyse de l'√©tiquette en cours‚Ä¶</div>
    <div class="ai-result-box" id="ai-result-box">
      <strong>‚úÖ D√©tection IA r√©ussie !</strong>
      <span id="ai-result-text"></span>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Emoji</label>
        <input type="text" id="f-emoji" placeholder="ü•ï" maxlength="2">
      </div>
      <div class="form-group">
        <label>Cat√©gorie</label>
        <select id="f-cat">
          <option value="frigo">‚ùÑÔ∏è Frigo</option>
          <option value="placard">üö™ Placard</option>
          <option value="congelateur">üßä Cong√©lo</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label>Nom de l'aliment</label>
      <input type="text" id="f-name" placeholder="Ex: Carottes bio">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Quantit√©</label>
        <input type="text" id="f-qty" placeholder="Ex: 500g, 3 pi√®ces">
      </div>
      <div class="form-group">
        <label>Date de p√©remption</label>
        <input type="date" id="f-exp">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Calories (pour 100g)</label>
        <input type="number" id="f-cal" placeholder="kcal">
      </div>
      <div class="form-group">
        <label>Prot√©ines (g)</label>
        <input type="number" id="f-prot" placeholder="g">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Glucides (g)</label>
        <input type="number" id="f-gluc" placeholder="g">
      </div>
      <div class="form-group">
        <label>Lipides (g)</label>
        <input type="number" id="f-lip" placeholder="g">
      </div>
    </div>
    <div class="form-group">
      <label>Identifiant NFC</label>
      <input type="text" id="f-nfc" placeholder="Ex: NFC-001 (ou scanner automatique)">
    </div>
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeModal('food-modal')">Annuler</button>
      <button class="btn-primary" onclick="saveFood()">Enregistrer</button>
    </div>
  </div>
</div>

<!-- MODAL NFC SCAN -->
<div class="modal-overlay nfc-scan-modal" id="nfc-modal">
  <div class="modal" style="text-align:center;">
    <h2>Scan NFC</h2>
    <div class="nfc-animation">
      <div class="nfc-ring"></div>
      <p style="color:var(--text-muted);font-size:0.9rem;" id="nfc-status">Approchez votre badge NFC‚Ä¶</p>
    </div>
    <button class="btn-secondary" onclick="simulateScan()">Simuler un scan</button>
    <button class="btn-secondary" style="margin-left:8px;" onclick="closeModal('nfc-modal')">Fermer</button>
  </div>
</div>

<!-- MODAL COURSES -->
<div class="modal-overlay" id="course-modal">
  <div class="modal">
    <h2>Ajouter √† la liste</h2>
    <div class="form-group">
      <label>Article</label>
      <input type="text" id="c-name" placeholder="Ex: Lait entier">
    </div>
    <div class="form-group">
      <label>Quantit√©</label>
      <input type="text" id="c-qty" placeholder="Ex: 2L">
    </div>
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeModal('course-modal')">Annuler</button>
      <button class="btn-primary" onclick="saveCourse()">Ajouter</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ========== DATA ==========
let foods = [
  { id: 1, emoji: 'ü•ï', name: 'Carottes bio', category: 'frigo', qty: '500g', expDate: futureDays(5), nfc: 'NFC-001', cal: 41, prot: 0.9, gluc: 9.6, lip: 0.2 },
  { id: 2, emoji: 'ü•õ', name: 'Lait demi-√©cr√©m√©', category: 'frigo', qty: '1L', expDate: futureDays(2), nfc: 'NFC-002', cal: 46, prot: 3.2, gluc: 4.8, lip: 1.5 },
  { id: 3, emoji: 'üßÄ', name: 'Emmental', category: 'frigo', qty: '250g', expDate: futureDays(12), nfc: 'NFC-003', cal: 380, prot: 28, gluc: 0.5, lip: 29 },
  { id: 4, emoji: 'üçó', name: 'Poulet r√¥ti', category: 'frigo', qty: '800g', expDate: futureDays(-1), nfc: 'NFC-004', cal: 165, prot: 31, gluc: 0, lip: 3.6 },
  { id: 5, emoji: 'üçù', name: 'P√¢tes compl√®tes', category: 'placard', qty: '500g', expDate: futureDays(180), nfc: 'NFC-005', cal: 352, prot: 13, gluc: 70, lip: 2 },
  { id: 6, emoji: 'ü•´', name: 'Tomates pel√©es', category: 'placard', qty: '2 bo√Ætes', expDate: futureDays(365), nfc: 'NFC-006', cal: 25, prot: 1.3, gluc: 4.5, lip: 0.3 },
  { id: 7, emoji: 'üßä', name: '√âpinards surgel√©s', category: 'congelateur', qty: '750g', expDate: futureDays(90), nfc: 'NFC-007', cal: 23, prot: 2.9, gluc: 3.6, lip: 0.4 },
  { id: 8, emoji: 'ü•ö', name: '≈íufs (x12)', category: 'frigo', qty: '12 pi√®ces', expDate: futureDays(3), nfc: 'NFC-008', cal: 155, prot: 13, gluc: 1.1, lip: 11 },
];

let shopping = [
  { id: 1, name: 'Yaourts nature', qty: 'x6', done: false },
  { id: 2, name: 'Beurre doux', qty: '250g', done: false },
  { id: 3, name: 'Farine T55', qty: '1kg', done: true },
];

let history = [
  { date: '25/02/2026 09:14', action: 'Scan NFC ‚Äì Lait demi-√©cr√©m√© (NFC-002)', type: 'scan' },
  { date: '24/02/2026 18:32', action: 'Ajout ‚Äì √âpinards surgel√©s', type: 'add' },
  { date: '24/02/2026 12:05', action: 'Consomm√© ‚Äì Yaourts nature (500g)', type: 'consume' },
  { date: '23/02/2026 20:11', action: 'P√©rim√© ‚Äì Jus d\'orange', type: 'expire' },
  { date: '22/02/2026 17:44', action: 'Scan NFC ‚Äì Carottes bio (NFC-001)', type: 'scan' },
];

let editingId = null;
let currentFilter = 'all';
let recipes = [
  {
    name: 'Gratin de p√¢tes au poulet',
    time: '35 min',
    ingredients: ['P√¢tes compl√®tes', 'Poulet r√¥ti', 'Emmental', 'Lait demi-√©cr√©m√©'],
    missing: ['B√©chamel']
  },
  {
    name: 'Omelette aux √©pinards',
    time: '15 min',
    ingredients: ['≈íufs (x12)', '√âpinards surgel√©s', 'Emmental'],
    missing: []
  },
  {
    name: 'Sauce tomate maison',
    time: '20 min',
    ingredients: ['Tomates pel√©es', 'Carottes bio'],
    missing: ['Oignon', 'Ail']
  },
];

function futureDays(n) {
  const d = new Date();
  d.setDate(d.getDate() + n);
  return d.toISOString().split('T')[0];
}

function daysUntil(dateStr) {
  const today = new Date();
  today.setHours(0,0,0,0);
  const exp = new Date(dateStr);
  return Math.round((exp - today) / 86400000);
}

function formatDate(dateStr) {
  const d = new Date(dateStr);
  return d.toLocaleDateString('fr-FR');
}

// ========== RENDER ==========
function renderAll() {
  renderStats();
  renderInventaire();
  renderAlerts();
  renderShopping();
  renderRecipes();
  renderHistory();
}

function renderStats() {
  const total = foods.length;
  const expiring = foods.filter(f => { const d = daysUntil(f.expDate); return d >= 0 && d <= 3; }).length;
  const expired = foods.filter(f => daysUntil(f.expDate) < 0).length;
  const scanned = foods.filter(f => f.nfc).length;
  document.getElementById('stats-row').innerHTML = `
    <div class="stat-card"><div class="number">${total}</div><div class="label">Aliments recens√©s</div></div>
    <div class="stat-card"><div class="number">${scanned}</div><div class="label">Badges NFC actifs</div></div>
    <div class="stat-card warning"><div class="number">${expiring}</div><div class="label">Expirent bient√¥t</div></div>
    <div class="stat-card danger"><div class="number">${expired}</div><div class="label">P√©rim√©s</div></div>
  `;
}

function renderInventaire() {
  const search = document.getElementById('search-input').value.toLowerCase();
  let filtered = foods;
  if (currentFilter !== 'all') filtered = filtered.filter(f => f.category === currentFilter);
  if (search) filtered = filtered.filter(f => f.name.toLowerCase().includes(search));

  document.getElementById('food-grid').innerHTML = filtered.map(f => {
    const days = daysUntil(f.expDate);
    let cardClass = '';
    let badgeHtml = '';
    if (days < 0) { cardClass = 'expired'; badgeHtml = `<span class="badge badge-expired">‚ö†Ô∏è P√©rim√©</span>`; }
    else if (days <= 3) { cardClass = 'expiring'; badgeHtml = `<span class="badge badge-expiring">‚è∞ ${days}j restants</span>`; }
    else { badgeHtml = `<span class="badge badge-ok">‚úì ${days}j</span>`; }
    return `
    <div class="food-card ${cardClass}">
      <div class="food-card-header">
        <span class="food-emoji">${f.emoji}</span>
        <div class="food-actions">
          <button class="icon-btn" onclick="editFood(${f.id})" title="Modifier">‚úèÔ∏è</button>
          <button class="icon-btn" onclick="deleteFood(${f.id})" title="Supprimer">üóëÔ∏è</button>
        </div>
      </div>
      <div class="food-name">${f.name}</div>
      <div class="food-category">${f.category === 'frigo' ? '‚ùÑÔ∏è Frigo' : f.category === 'placard' ? 'üö™ Placard' : 'üßä Cong√©lo'}</div>
      <div class="food-meta">
        <span class="badge badge-qty">üì¶ ${f.qty}</span>
        ${badgeHtml}
      </div>
      <div class="nutrition-grid">
        <div class="nutrition-cell"><div class="val">${f.cal}</div><div class="lbl">kcal</div></div>
        <div class="nutrition-cell"><div class="val">${f.prot}g</div><div class="lbl">Prot√©ines</div></div>
        <div class="nutrition-cell"><div class="val">${f.gluc}g</div><div class="lbl">Glucides</div></div>
        <div class="nutrition-cell"><div class="val">${f.lip}g</div><div class="lbl">Lipides</div></div>
      </div>
      ${f.nfc ? `<div class="nfc-tag" style="margin-top:10px;">üì° ${f.nfc} ¬∑ Exp. ${formatDate(f.expDate)}</div>` : ''}
    </div>`;
  }).join('');
  if (!filtered.length) {
    document.getElementById('food-grid').innerHTML = '<p style="color:var(--text-muted);font-size:0.9rem;">Aucun aliment trouv√©.</p>';
  }
}

function renderAlerts() {
  const expiring = foods.filter(f => { const d = daysUntil(f.expDate); return d >= 0 && d <= 3; });
  const expired = foods.filter(f => daysUntil(f.expDate) < 0);
  let html = '';
  if (!expiring.length && !expired.length) {
    html = '<p style="color:var(--text-muted);font-size:0.9rem;">Aucune alerte pour le moment üéâ</p>';
  }
  expired.forEach(f => {
    html += `<div class="alert-item expired"><span class="alert-icon">üî¥</span><div class="alert-text"><strong>${f.emoji} ${f.name}</strong><span>P√©rim√© depuis le ${formatDate(f.expDate)} ¬∑ ${f.nfc || 'Pas de tag NFC'}</span></div><button class="icon-btn" onclick="deleteFood(${f.id})">üóëÔ∏è</button></div>`;
  });
  expiring.forEach(f => {
    const d = daysUntil(f.expDate);
    html += `<div class="alert-item"><span class="alert-icon">üü°</span><div class="alert-text"><strong>${f.emoji} ${f.name}</strong><span>Expire dans ${d} jour(s) ‚Äì le ${formatDate(f.expDate)}</span></div></div>`;
  });
  document.getElementById('alerts-list').innerHTML = html;
}

function renderShopping() {
  document.getElementById('shopping-list').innerHTML = shopping.map(s => `
    <div class="shopping-item ${s.done ? 'done' : ''}">
      <input type="checkbox" id="s${s.id}" ${s.done ? 'checked' : ''} onchange="toggleShopping(${s.id})">
      <label for="s${s.id}">${s.name}</label>
      <span class="shopping-qty">${s.qty}</span>
      <button class="icon-btn" onclick="removeShopping(${s.id})">üóëÔ∏è</button>
    </div>
  `).join('');
}

function renderRecipes() {
  document.getElementById('recipes-list').innerHTML = recipes.map(r => `
    <div class="recipe-card">
      <h3>üë®‚Äçüç≥ ${r.name} <span style="font-size:0.75rem;color:var(--text-muted);font-family:DM Sans;">‚è± ${r.time}</span></h3>
      <div class="recipe-ingredients">
        ${r.ingredients.map(i => `<span class="ingredient-tag">${i}</span>`).join('')}
        ${r.missing.map(i => `<span class="ingredient-tag missing">‚ùå ${i}</span>`).join('')}
      </div>
      ${r.missing.length ? `<p style="font-size:0.75rem;color:var(--text-muted);margin-bottom:8px;">Il vous manque : ${r.missing.join(', ')}</p>` : '<p style="font-size:0.75rem;color:var(--green);margin-bottom:8px;">‚úì Tous les ingr√©dients disponibles !</p>'}
      <button class="recipe-btn" onclick="addMissingToShopping('${r.name}', ${JSON.stringify(r.missing)})">Ajouter manquants aux courses</button>
    </div>
  `).join('');
}

function renderHistory() {
  const types = { scan: 'h-scan', add: 'h-add', consume: 'h-consume', expire: 'h-expire' };
  const labels = { scan: 'Scan', add: 'Ajout', consume: 'Consomm√©', expire: 'P√©rim√©' };
  document.getElementById('history-list').innerHTML = history.map(h => `
    <div class="history-item">
      <span class="history-date">${h.date}</span>
      <span class="history-action">${h.action}</span>
      <span class="history-badge ${types[h.type]}">${labels[h.type]}</span>
    </div>
  `).join('');
}

// ========== INTERACTIONS ==========
function switchTab(name, btn) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  btn.classList.add('active');
}

function setFilter(f, el) {
  currentFilter = f;
  document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  renderInventaire();
}

function openAddModal() {
  editingId = null;
  document.getElementById('modal-title').textContent = 'Ajouter un aliment';
  ['f-emoji','f-name','f-qty','f-exp','f-nfc','f-cal','f-prot','f-gluc','f-lip'].forEach(id => {
    const el = document.getElementById(id); if (el) el.value = '';
  });
  resetPhotoScan();
  document.getElementById('food-modal').classList.add('open');
}

function editFood(id) {
  const f = foods.find(x => x.id === id);
  editingId = id;
  document.getElementById('modal-title').textContent = 'Modifier un aliment';
  document.getElementById('f-emoji').value = f.emoji;
  document.getElementById('f-name').value = f.name;
  document.getElementById('f-cat').value = f.category;
  document.getElementById('f-qty').value = f.qty;
  document.getElementById('f-exp').value = f.expDate;
  document.getElementById('f-nfc').value = f.nfc || '';
  document.getElementById('f-cal').value = f.cal || '';
  document.getElementById('f-prot').value = f.prot || '';
  document.getElementById('f-gluc').value = f.gluc || '';
  document.getElementById('f-lip').value = f.lip || '';
  document.getElementById('food-modal').classList.add('open');
}

function saveFood() {
  const f = {
    emoji: document.getElementById('f-emoji').value || 'üçΩÔ∏è',
    name: document.getElementById('f-name').value.trim(),
    category: document.getElementById('f-cat').value,
    qty: document.getElementById('f-qty').value.trim(),
    expDate: document.getElementById('f-exp').value,
    nfc: document.getElementById('f-nfc').value.trim(),
    cal: parseFloat(document.getElementById('f-cal').value) || 0,
    prot: parseFloat(document.getElementById('f-prot').value) || 0,
    gluc: parseFloat(document.getElementById('f-gluc').value) || 0,
    lip: parseFloat(document.getElementById('f-lip').value) || 0,
  };
  if (!f.name) { showToast('Veuillez entrer un nom.'); return; }
  if (editingId) {
    const idx = foods.findIndex(x => x.id === editingId);
    foods[idx] = { ...foods[idx], ...f };
    addHistory(`Modifi√© ‚Äì ${f.name}`, 'add');
  } else {
    f.id = Date.now();
    foods.push(f);
    addHistory(`Ajout ‚Äì ${f.name}`, 'add');
  }
  closeModal('food-modal');
  renderAll();
  showToast(editingId ? 'Aliment modifi√© !' : 'Aliment ajout√© !');
}

function deleteFood(id) {
  const f = foods.find(x => x.id === id);
  foods = foods.filter(x => x.id !== id);
  addHistory(`Supprim√© ‚Äì ${f.name}`, 'expire');
  renderAll();
  showToast('Aliment supprim√©.');
}

function openNfcScan() {
  document.getElementById('nfc-status').textContent = 'Approchez votre badge NFC‚Ä¶';
  document.getElementById('nfc-modal').classList.add('open');
}

function simulateScan() {
  const random = foods[Math.floor(Math.random() * foods.length)];
  document.getElementById('nfc-status').textContent = `‚úÖ D√©tect√© : ${random.emoji} ${random.name} (${random.nfc || 'NFC inconnu'})`;
  addHistory(`Scan NFC ‚Äì ${random.name} (${random.nfc || '?'})`, 'scan');
  setTimeout(() => {
    closeModal('nfc-modal');
    renderAll();
    showToast(`üì° Scann√© : ${random.name}`);
  }, 1800);
}

function toggleShopping(id) {
  const s = shopping.find(x => x.id === id);
  s.done = !s.done;
  if (s.done) addHistory(`Achet√© ‚Äì ${s.name}`, 'consume');
  renderShopping();
  renderHistory();
}

function removeShopping(id) {
  shopping = shopping.filter(x => x.id !== id);
  renderShopping();
}

function openAddCourse() {
  document.getElementById('c-name').value = '';
  document.getElementById('c-qty').value = '';
  document.getElementById('course-modal').classList.add('open');
}

function saveCourse() {
  const name = document.getElementById('c-name').value.trim();
  const qty = document.getElementById('c-qty').value.trim();
  if (!name) { showToast('Entrez un article.'); return; }
  shopping.push({ id: Date.now(), name, qty: qty || '1', done: false });
  closeModal('course-modal');
  renderShopping();
  showToast('Article ajout√© aux courses !');
}

function autoFillShopping() {
  const expiring = foods.filter(f => daysUntil(f.expDate) <= 3 && daysUntil(f.expDate) >= 0);
  let added = 0;
  expiring.forEach(f => {
    if (!shopping.find(s => s.name.toLowerCase() === f.name.toLowerCase())) {
      shopping.push({ id: Date.now() + added, name: f.name, qty: f.qty, done: false });
      added++;
    }
  });
  renderShopping();
  showToast(added ? `${added} article(s) ajout√©(s) auto !` : 'Rien √† ajouter.');
}

function clearDone() {
  shopping = shopping.filter(s => !s.done);
  renderShopping();
  showToast('Articles coch√©s supprim√©s.');
}

function addMissingToShopping(recipeName, missing) {
  missing.forEach(m => {
    if (!shopping.find(s => s.name === m)) {
      shopping.push({ id: Date.now(), name: m, qty: '1', done: false });
    }
  });
  renderShopping();
  showToast(`Ingr√©dients manquants ajout√©s pour "${recipeName}" !`);
}

// ========== BARCODE SCANNER ==========
let html5QrCode = null;
let scannerActive = false;

async function toggleBarcodeScanner() {
  if (scannerActive) {
    stopBarcodeScanner();
    return;
  }
  const readerDiv = document.getElementById('barcode-reader');
  readerDiv.style.display = 'block';
  document.querySelector('.barcode-btn').textContent = '‚èπ Arr√™ter le scan';

  html5QrCode = new Html5Qrcode("barcode-reader");
  try {
    await html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: { width: 250, height: 100 }, formatsToSupport: [
        Html5QrcodeSupportedFormats.EAN_13,
        Html5QrcodeSupportedFormats.EAN_8,
        Html5QrcodeSupportedFormats.CODE_128,
        Html5QrcodeSupportedFormats.UPC_A,
        Html5QrcodeSupportedFormats.UPC_E,
      ]},
      onBarcodeDetected,
      () => {}
    );
    scannerActive = true;
  } catch (err) {
    readerDiv.style.display = 'none';
    document.querySelector('.barcode-btn').innerHTML = '<span>üì∑</span> Scanner le code-barres';
    showToast('Cam√©ra non disponible. Essayez la saisie manuelle.');
  }
}

function stopBarcodeScanner() {
  if (html5QrCode && scannerActive) {
    html5QrCode.stop().then(() => {
      document.getElementById('barcode-reader').style.display = 'none';
      document.querySelector('.barcode-btn').innerHTML = '<span>üì∑</span> Scanner le code-barres';
      scannerActive = false;
    });
  }
}

async function onBarcodeDetected(barcode) {
  stopBarcodeScanner();
  showToast('Code-barres d√©tect√© : ' + barcode);
  await fetchProductFromBarcode(barcode);
}

async function fetchProductFromBarcode(barcode) {
  showToast('üîç Recherche du produit‚Ä¶');
  try {
    const res = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
    const data = await res.json();
    if (data.status !== 1 || !data.product) {
      showToast('Produit non trouv√© dans la base Open Food Facts.');
      return;
    }
    const p = data.product;
    const name = p.product_name_fr || p.product_name || p.generic_name || '';
    const cal = Math.round(p.nutriments?.['energy-kcal_100g'] || p.nutriments?.energy_100g / 4.184 || 0);
    const prot = parseFloat(p.nutriments?.proteins_100g || 0).toFixed(1);
    const gluc = parseFloat(p.nutriments?.carbohydrates_100g || 0).toFixed(1);
    const lip = parseFloat(p.nutriments?.fat_100g || 0).toFixed(1);

    // Fill fields
    if (name) document.getElementById('f-name').value = name;
    if (cal) document.getElementById('f-cal').value = cal;
    if (prot) document.getElementById('f-prot').value = prot;
    if (gluc) document.getElementById('f-gluc').value = gluc;
    if (lip) document.getElementById('f-lip').value = lip;

    // Detect category
    const cats = (p.categories || '').toLowerCase();
    if (cats.includes('surgel√©') || cats.includes('frozen')) document.getElementById('f-cat').value = 'congelateur';
    else if (cats.includes('conserve') || cats.includes('√©picerie') || cats.includes('biscuit') || cats.includes('c√©r√©ale')) document.getElementById('f-cat').value = 'placard';
    else document.getElementById('f-cat').value = 'frigo';

    // Emoji guess
    const nameLow = name.toLowerCase();
    const emojiMap = [
      ['lait','ü•õ'],['fromage','üßÄ'],['beurre','üßà'],['yaourt','ü•õ'],['cr√®me','ü•õ'],
      ['poulet','üçó'],['b≈ìuf','ü•©'],['porc','ü•©'],['poisson','üêü'],['saumon','üêü'],
      ['carotte','ü•ï'],['tomate','üçÖ'],['pomme de terre','ü•î'],['salade','ü•ó'],
      ['pain','üçû'],['p√¢tes','üçù'],['riz','üçö'],['farine','üåæ'],
      ['jus','ü•§'],['eau','üíß'],['caf√©','‚òï'],['th√©','üçµ'],
      ['chocolat','üç´'],['biscuit','üç™'],['glace','üç¶'],
      ['≈ìuf','ü•ö'],['oeuf','ü•ö'],['huile','ü´ô'],
    ];
    let emoji = 'üçΩÔ∏è';
    for (const [kw, em] of emojiMap) { if (nameLow.includes(kw)) { emoji = em; break; } }
    if (!document.getElementById('f-emoji').value) document.getElementById('f-emoji').value = emoji;

    const resultBox = document.getElementById('barcode-result-box');
    resultBox.style.display = 'block';
    document.getElementById('barcode-result-text').innerHTML =
      `<strong>${name || 'Produit inconnu'}</strong>` +
      (cal ? ` ¬∑ ${cal} kcal/100g` : '') +
      `<br><span style="font-size:0.75rem;opacity:0.8;">Source : Open Food Facts ¬∑ Compl√©tez la date d'expiration ci-dessous üëá</span>`;

    addHistory(`Code-barres scann√© ‚Äì ${name} (${barcode})`, 'scan');
    renderHistory();

  } catch (err) {
    showToast('Erreur de connexion √† Open Food Facts.');
  }
}

function resetPhotoScan() {
  document.getElementById('photo-preview').style.display = 'none';
  document.getElementById('ai-result-box').style.display = 'none';
  document.getElementById('scanning-spinner').style.display = 'none';
  document.getElementById('photo-scan-area').querySelector('.photo-scan-label').style.display = 'block';
  document.getElementById('photo-input').value = '';
}

async function handlePhotoUpload(event) {
  const file = event.target.files[0];
  if (!file) return;

  // Show preview
  const reader = new FileReader();
  reader.onload = async (e) => {
    const base64 = e.target.result;
    const preview = document.getElementById('photo-preview');
    preview.src = base64;
    preview.style.display = 'block';
    document.getElementById('photo-scan-area').querySelector('.photo-scan-label').style.display = 'none';

    // Show spinner
    document.getElementById('scanning-spinner').style.display = 'block';
    document.getElementById('ai-result-box').style.display = 'none';

    // Call Claude API with the image
    try {
      const base64Data = base64.split(',')[1];
      const mediaType = file.type;

      const response = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 1000,
          messages: [{
            role: "user",
            content: [
              {
                type: "image",
                source: { type: "base64", media_type: mediaType, data: base64Data }
              },
              {
                type: "text",
                text: `Analyse cette photo d'une √©tiquette alimentaire. R√©ponds UNIQUEMENT en JSON avec ce format exact (pas de markdown, pas d'explication) :
{"date_expiration":"YYYY-MM-DD","nom_produit":"...","confiance":"haute|moyenne|faible","details":"..."}

- date_expiration : la date de p√©remption trouv√©e (DLC, DDM, √† consommer avant, best before), au format YYYY-MM-DD. Si tu n'en trouves pas, mets null.
- nom_produit : le nom du produit si visible, sinon null.
- confiance : ton niveau de confiance dans la d√©tection.
- details : ce que tu as lu sur l'√©tiquette (texte court).`
              }
            ]
          }]
        })
      });

      const data = await response.json();
      const text = data.content?.[0]?.text || '';

      let result;
      try {
        result = JSON.parse(text.replace(/```json|```/g, '').trim());
      } catch {
        result = { date_expiration: null, nom_produit: null, confiance: 'faible', details: text };
      }

      document.getElementById('scanning-spinner').style.display = 'none';

      if (result.date_expiration) {
        document.getElementById('f-exp').value = result.date_expiration;
        if (result.nom_produit && !document.getElementById('f-name').value) {
          document.getElementById('f-name').value = result.nom_produit;
        }
        const resultBox = document.getElementById('ai-result-box');
        resultBox.style.display = 'block';
        document.getElementById('ai-result-text').textContent =
          `Date d√©tect√©e : ${formatDate(result.date_expiration)}${result.nom_produit ? ' ¬∑ Produit : ' + result.nom_produit : ''} (confiance : ${result.confiance})`;
      } else {
        const resultBox = document.getElementById('ai-result-box');
        resultBox.style.background = 'var(--amber-pale)';
        resultBox.style.borderColor = 'var(--amber)';
        resultBox.style.color = 'var(--amber)';
        resultBox.style.display = 'block';
        document.getElementById('ai-result-text').textContent =
          `Impossible de d√©tecter la date automatiquement. Veuillez la saisir manuellement. ${result.details ? '(' + result.details + ')' : ''}`;
      }

    } catch (err) {
      document.getElementById('scanning-spinner').style.display = 'none';
      showToast('Erreur lors de l\'analyse. Veuillez saisir la date manuellement.');
    }
  };
  reader.readAsDataURL(file);
}

function closeModal(id) {
  if (id === 'food-modal') stopBarcodeScanner();
  document.getElementById(id).classList.remove('open');
}

function addHistory(action, type) {
  const now = new Date();
  const date = `${now.toLocaleDateString('fr-FR')} ${now.toLocaleTimeString('fr-FR', {hour:'2-digit',minute:'2-digit'})}`;
  history.unshift({ date, action, type });
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2800);
}

// Click outside modal to close
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', e => {
    if (e.target === overlay) overlay.classList.remove('open');
  });
});

renderAll();
</script>
</body>
</html>
