<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kitchen Master V23 - VISION OCR</title>
    
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

    <style>
        :root { --p: #6c5ce7; --s: #00cec9; --d: #ff7675; --f: #2ed573; --bg: #f0f2f5; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        .card { background: white; padding: 15px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .btn { border: none; padding: 14px; border-radius: 12px; font-weight: bold; width: 100%; margin-top: 10px; color: white; cursor: pointer; }
        .btn-p { background: var(--p); } .btn-s { background: var(--s); } .btn-f { background: var(--f); }
        input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; margin-top: 5px; box-sizing: border-box; }
        #camera-container { width: 100%; background: #000; border-radius: 15px; overflow: hidden; position: relative; min-height: 250px; }
        #reader { width: 100%; }
        #loading-ocr { display:none; text-align: center; color: var(--p); font-weight: bold; padding: 10px; }
    </style>
</head>
<body>

<div class="card">
    <div id="camera-container">
        <div id="reader"></div>
    </div>
    <button class="btn btn-p" onclick="window.startScan()">1. Scanner Produit (Code-barres)</button>
    <button class="btn btn-s" onclick="window.readDateOCR()">2. üîç Lire la Date (Vision IA)</button>
    <div id="loading-ocr">ü§ñ L'IA analyse l'image...</div>
</div>

<div class="card">
    <input type="text" id="foodName" placeholder="Produit">
    <input type="date" id="expiryDate">
    <button class="btn btn-f" onclick="window.save()">üíæ ENREGISTRER</button>
</div>

<div id="list"></div>

<script>
    window.db = JSON.parse(localStorage.getItem('km_v23')) || [];
    let html5QrCode = new Html5Qrcode("reader");

    window.startScan = function() {
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => {
            fetch(`https://world.openfoodfacts.org/api/v0/product/${text}.json`)
            .then(r => r.json()).then(data => {
                if(data.status === 1) document.getElementById('foodName').value = data.product.product_name;
            });
        });
    };

    // --- LA MAGIE DE LA VISION IA ---
    window.readDateOCR = async function() {
        const loader = document.getElementById('loading-ocr');
        loader.style.display = "block";
        
        try {
            // 1. Capture d'image depuis le flux vid√©o
            const video = document.querySelector('video');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            // 2. Analyse Tesseract IA
            const result = await Tesseract.recognize(canvas, 'eng', { logger: m => console.log(m) });
            const text = result.data.text;
            console.log("Texte d√©tect√©:", text);

            // 3. Recherche d'un format de date (JJ/MM/AAAA ou JJ.MM.AA)
            const dateRegex = /(\d{2})[\/\.\- ](\d{2})[\/\.\- ](\d{2,4})/;
            const match = text.match(dateRegex);

            if (match) {
                let day = match[1], month = match[2], year = match[3];
                if(year.length === 2) year = "20" + year;
                document.getElementById('expiryDate').value = `${year}-${month}-${day}`;
                alert("‚úÖ IA : Date trouv√©e ! " + day + "/" + month + "/" + year);
            } else {
                alert("‚ùå IA : Pas de date nette trouv√©e. Rapproche l'appareil de la date.");
            }
        } catch (e) {
            alert("Erreur Vision: " + e);
        }
        loader.style.display = "none";
    };

    window.save = function() {
        const n = document.getElementById('foodName').value;
        const d = document.getElementById('expiryDate').value;
        if(!n || !d) return;
        window.db.push({n, d});
        localStorage.setItem('km_v23', JSON.stringify(window.db));
        window.render();
    };

    window.render = function() {
        const l = document.getElementById('list');
        l.innerHTML = window.db.map(i => `<div class="card"><b>${i.n}</b> - ${i.d}</div>`).join('');
    };

    window.render();
</script>
</body>
</html>

