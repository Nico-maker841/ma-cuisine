<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kitchen Titan v11</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --p: #6c5ce7; --s: #00cec9; --d: #ff7675; --f: #2ed573; --bg: #f8f9fa; --txt: #2d3436; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--txt); margin: 0; padding: 10px; padding-bottom: 80px; }
        .card { background: white; padding: 15px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .btn { border: none; padding: 12px; border-radius: 12px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; transition: 0.2s; }
        .btn:active { transform: scale(0.98); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        /* Stats Dashboard */
        .dash { display: flex; justify-content: space-around; text-align: center; font-size: 11px; margin-bottom: 10px; }
        .dash b { display: block; font-size: 16px; color: var(--p); }

        /* Sync Panel */
        #syncZone { font-size: 12px; background: #eee; padding: 10px; border-radius: 10px; display: none; }

        input, select { width: 100%; padding: 12px; margin: 5px 0; border: 2px solid #eee; border-radius: 10px; box-sizing: border-box; }
        .item { display: flex; align-items: center; padding: 10px; background: white; border-radius: 15px; margin-bottom: 8px; border-left: 5px solid #ccc; }
        .urgent { border-left-color: var(--d); }
    </style>
</head>
<body>

<div class="card">
    <div class="dash">
        <div><b><span id="statMoney">0</span>‚Ç¨</b>√âconomis√©s</div>
        <div><b><span id="statCo2">0</span>kg</b>CO2 Sauv√©s</div>
        <div><b><span id="statEaten">0</span></b>Manges</div>
    </div>
    <button class="btn" style="background:#dfe6e9;" onclick="toggleSync()">üì° Mode Famille (Synchro)</button>
    <div id="syncZone">
        Ton ID : <span id="myId">...</span><br>
        <input type="text" id="peerId" placeholder="ID de l'autre t√©l√©phone">
        <button class="btn" onclick="connectToPeer()" style="background:var(--s); color:white;">Se Connecter</button>
    </div>
</div>

<div id="reader" style="border-radius:20px; overflow:hidden; margin-bottom:15px;"></div>

<div class="card">
    <div class="grid">
        <button class="btn" style="background:var(--p); color:white;" onclick="readDateIA()">üìÖ Scan Date</button>
        <button class="btn" style="background:var(--s); color:white;" onclick="recognizeFood()">üçé Scan Objet</button>
    </div>
    <input type="text" id="name" placeholder="Nom de l'aliment">
    <input type="date" id="date">
    <button class="btn" style="background:#1877f2; color:white;" onclick="add()">üíæ Ajouter au Stock</button>
</div>

<div id="list"></div>

<div style="position:fixed; bottom:0; left:0; width:100%; background:white; display:flex; padding:10px; border-top:1px solid #ddd;">
    <button class="btn" style="background:var(--f); color:white;" onclick="shareWA()">üõí WhatsApp Courses</button>
</div>

<script>
    let stock = JSON.parse(localStorage.getItem('kStock')) || [];
    let stats = JSON.parse(localStorage.getItem('kStats')) || { money: 0, co2: 0, eaten: 0 };
    let peer, conn;

    // --- 1. SYNCHRO FAMILLE ---
    function toggleSync() { document.getElementById('syncZone').style.display = 'block'; }
    
    peer = new Peer();
    peer.on('open', id => document.getElementById('myId').innerText = id);
    peer.on('connection', c => {
        conn = c;
        setupConn();
    });

    function connectToPeer() {
        conn = peer.connect(document.getElementById('peerId').value);
        setupConn();
    }

    function setupConn() {
        conn.on('open', () => {
            conn.send(stock);
            alert("Connect√© ! Les stocks sont synchronis√©s.");
        });
        conn.on('data', data => {
            stock = data;
            save(); render();
        });
    }

    // --- 2. LOGIQUE M√âTIER ---
    function add() {
        const n = document.getElementById('name').value;
        const d = document.getElementById('date').value;
        if(!n || !d) return;
        stock.push({ n, d, id: Date.now() });
        if(conn) conn.send(stock);
        save(); render();
    }

    function consume(id) {
        const i = stock.findIndex(x => x.id === id);
        stats.money += 2.5; // Estim moyen
        stats.co2 += 1.2;   // Estim moyen
        stats.eaten += 1;
        stock.splice(i, 1);
        save(); render();
    }

    // --- 3. EXPORT AGENDA ---
    function exportToCal(name, date) {
        const d = date.replace(/-/g, '');
        const url = `https://www.google.com/calendar/render?action=TEMPLATE&text=P√©rime : ${name}&dates=${d}/${d}`;
        window.open(url);
    }

    // --- 4. RECONNAISSANCE VISUELLE (SIMUL√âE) ---
    function recognizeFood() {
        const items = ["Pomme", "Banane", "Courgette", "Pain", "Lait", "Oeufs"];
        const rand = items[Math.floor(Math.random()*items.length)];
        document.getElementById('name').value = rand;
        alert("IA Vision : J'ai reconnu un(e) " + rand);
    }

    function save() {
        localStorage.setItem('kStock', JSON.stringify(stock));
        localStorage.setItem('kStats', JSON.stringify(stats));
    }

    function render() {
        const l = document.getElementById('list');
        l.innerHTML = "";
        document.getElementById('statMoney').innerText = stats.money.toFixed(1);
        document.getElementById('statCo2').innerText = stats.co2.toFixed(1);
        document.getElementById('statEaten').innerText = stats.eaten;

        stock.sort((a,b) => new Date(a.d) - new Date(b.d)).forEach(it => {
            const isUrgent = (new Date(it.d) - new Date()) / 86400000 < 2;
            l.innerHTML += `
                <div class="item ${isUrgent?'urgent':''}">
                    <div style="flex-grow:1">
                        <b>${it.n}</b><br><small>Fin : ${it.d}</small>
                    </div>
                    <div style="display:flex; gap:5px;">
                        <button onclick="exportToCal('${it.n}', '${it.d}')" style="background:none; border:none;">üìÖ</button>
                        <button onclick="consume(${it.id})" style="background:none; border:none; font-size:20px;">‚úÖ</button>
                    </div>
                </div>`;
        });
    }

    // Scanner simple int√©gr√©
    let html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => {
        fetch(`https://world.openfoodfacts.org/api/v0/product/${text}.json`)
        .then(r => r.json()).then(d => {
            if(d.status === 1) document.getElementById('name').value = d.product.product_name;
        });
    });

    function shareWA() {
        let t = "üõí Liste de courses : " + stock.map(x => x.n).join(', ');
        window.open(`https://wa.me/?text=${encodeURIComponent(t)}`);
    }

    render();
</script>
</body>
</html>
