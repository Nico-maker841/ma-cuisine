<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kitchen Master v13</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <style>
        :root { --p: #6c5ce7; --s: #00cec9; --d: #ff7675; --f: #2ed573; --bg: #fdfdfd; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 15px; padding-bottom: 100px; color: #2d3436; }
        .card { background: white; padding: 15px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); margin-bottom: 15px; }
        .btn { border: none; padding: 12px; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 14px; color: white; }
        .nutri-gauge { height: 10px; background: #eee; border-radius: 5px; margin: 10px 0; overflow: hidden; }
        .nutri-fill { height: 100%; background: linear-gradient(to right, #2ed573, #ff7675); width: 50%; }
        .item { display: flex; align-items: center; padding: 12px; background: white; border-radius: 15px; margin-bottom: 8px; border: 1px solid #eee; }
        .qr-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; text-align: center; color: white; padding-top: 50px; }
    </style>
</head>
<body>

<div id="qrPopup" class="qr-overlay" onclick="this.style.display='none'">
    <h3>Scanne pour copier ma liste !</h3>
    <canvas id="shareQR" style="background:white; padding:10px; border-radius:10px;"></canvas>
    <p>Clique pour fermer</p>
</div>

<div class="card">
    <div style="display:flex; justify-content:space-between;">
        <b>Bilan Nutritionnel AI</b>
        <span onclick="speakStatus()" style="cursor:pointer; font-size:20px;">ðŸ”Š</span>
    </div>
    <div class="nutri-gauge"><div id="nutriFill" class="nutri-fill"></div></div>
    <small id="nutriMsg">Analyse de ton Ã©quilibre alimentaire...</small>
</div>

<div class="card">
    <b>âž• Ajouter un Ã©lÃ©ment</b>
    <div style="display:flex; gap:10px; margin-top:10px;">
        <button class="btn" style="background:var(--p); flex:1;" onclick="startScan()">ðŸ“· Scanner</button>
        <button class="btn" style="background:var(--s); flex:1;" onclick="addHomeMade()">ðŸ¥˜ Fait Maison</button>
    </div>
    <input type="text" id="itemName" placeholder="Nom de l'aliment" style="width:100%; margin-top:10px; padding:10px; border:1px solid #ddd; border-radius:8px;">
    <input type="date" id="itemDate" style="width:100%; margin-top:5px; padding:10px; border:1px solid #ddd; border-radius:8px;">
    <button class="btn" style="background:var(--f); width:100%; margin-top:10px;" onclick="saveToStock()">Enregistrer</button>
</div>

<div id="stockList"></div>

<div style="position:fixed; bottom:20px; right:20px;">
    <button class="btn" style="background:#333; border-radius:50%; width:60px; height:60px; font-size:24px;" onclick="showShareQR()">ðŸ”—</button>
</div>

<script>
    let stock = JSON.parse(localStorage.getItem('v13Stock')) || [];

    function addHomeMade() {
        document.getElementById('itemName').value = "Plat Maison ðŸ¥˜";
        let d = new Date(); d.setDate(d.getDate() + 3);
        document.getElementById('itemDate').value = d.toISOString().split('T')[0];
    }

    function saveToStock() {
        const n = document.getElementById('itemName').value;
        const d = document.getElementById('itemDate').value;
        if(n && d) {
            stock.push({ n, d, id: Date.now() });
            localStorage.setItem('v13Stock', JSON.stringify(stock));
            render();
        }
    }

    function speakStatus() {
        let msg = new SpeechSynthesisUtterance();
        let urgent = stock.filter(it => (new Date(it.d) - new Date()) / 86400000 < 2).length;
        msg.text = `Tu as ${stock.length} produits en stock, dont ${urgent} qui pÃ©riment bientÃ´t.`;
        msg.lang = 'fr-FR';
        window.speechSynthesis.speak(msg);
    }

    function showShareQR() {
        const data = stock.map(it => it.n).join(', ');
        const canvas = document.getElementById('shareQR');
        QRCode.toCanvas(canvas, data, { width: 250 });
        document.getElementById('qrPopup').style.display = 'block';
    }

    function render() {
        const list = document.getElementById('stockList');
        list.innerHTML = "";
        
        // Nutri-logic (simplifiÃ©)
        let balance = Math.min(stock.length * 10, 100);
        document.getElementById('nutriFill').style.width = balance + "%";
        document.getElementById('nutriMsg').innerText = balance > 50 ? "Ton frigo est bien diversifiÃ© !" : "Ajoute plus de lÃ©gumes !";

        stock.sort((a,b) => new Date(a.d) - new Date(b.d)).forEach((it, i) => {
            list.innerHTML += `
                <div class="item">
                    <div style="flex-grow:1"><b>${it.n}</b><br><small>${it.d}</small></div>
                    <button onclick="remove(${i})" style="border:none; background:none; font-size:20px;">âœ…</button>
                </div>`;
        });
    }

    function remove(i) {
        stock.splice(i, 1);
        localStorage.setItem('v13Stock', JSON.stringify(stock));
        render();
    }

    render();
</script>
</body>
</html>
