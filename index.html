<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kitchen Master - V19 S√âCURIS√â</title>
    
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --p: #6c5ce7; --s: #00cec9; --d: #ff7675; --f: #2ed573; --bg: #f0f2f5; --card: #ffffff; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 12px; padding-bottom: 50px; color: #333; }
        .card { background: var(--card); padding: 15px; border-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        
        #appStatus { background:#ff7675; color:white; text-align:center; padding:10px; border-radius:12px; margin-bottom:15px; font-weight:bold; font-size:13px; }
        
        .tab-container { display: flex; background: #eee; padding: 5px; border-radius: 12px; margin-bottom: 15px; }
        .tab-btn { flex: 1; border: none; padding: 12px 0; border-radius: 10px; font-weight: bold; background: transparent; color: #777; transition: 0.2s; }
        .tab-btn.active { background: white; color: var(--p); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .btn { border: none; padding: 14px; border-radius: 12px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; color: white; }
        .btn-p { background: var(--p); } .btn-s { background: var(--s); } .btn-f { background: var(--f); }
        
        input { width: 100%; padding: 14px; border-radius: 10px; border: 1px solid #ddd; margin-top: 5px; box-sizing: border-box; }
        
        .food-item { display: flex; align-items: center; padding: 12px; background: white; border-radius: 15px; margin-bottom: 8px; border-left: 5px solid #ccc; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; text-align: center; }
        .stat-box { background: #f8f9fa; padding: 10px; border-radius: 12px; border: 1px solid #eee; }
        .stat-box span { font-size: 18px; font-weight: bold; color: var(--p); display: block; }

        #cameraBox { background: #111; min-height: 200px; border-radius: 15px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        #reader { width: 100%; display: none; }
    </style>
</head>
<body>

<div id="appStatus">üî¥ Chargement... (Si ce message reste, le code a √©t√© mal copi√© sur GitHub)</div>

<div class="card">
    <h3 style="margin-top:0;">üìä Mon Bilan</h3>
    <div class="stats-row">
        <div class="stat-box"><span id="statMoney">0</span> ‚Ç¨ Sauv√©s</div>
        <div class="stat-box"><span id="statCo2">0</span> kg CO2</div>
    </div>
    <div style="height: 120px; width: 100%;">
        <canvas id="mainChart"></canvas>
    </div>
</div>

<div class="card">
    <h3 style="margin-top:0;">üé• Scanner</h3>
    <div id="cameraBox">
        <button id="btnStartCam" class="btn btn-p" style="width: 80%;" onclick="window.startCamera()">üì∑ Allumer la Cam√©ra</button>
        <div id="reader"></div>
    </div>
</div>

<div class="card">
    <div class="tab-container">
        <button id="btnFrigo" class="tab-btn active" onclick="window.switchZone('Frigo')">üßä Frigo</button>
        <button id="btnCongelo" class="tab-btn" onclick="window.switchZone('Congelo')">‚ùÑÔ∏è Cong√©lo</button>
        <button id="btnCellier" class="tab-btn" onclick="window.switchZone('Cellier')">üè† Cellier</button>
    </div>

    <input type="text" id="foodName" placeholder="Nom du produit">
    <input type="date" id="expiryDate">
    
    <div style="display: flex; gap: 10px;">
        <button class="btn btn-p" style="flex: 1;" onclick="window.askSub()">ü§ñ Substituer</button>
        <button class="btn btn-s" style="flex: 1;" onclick="window.askMenu()">üë®‚Äçüç≥ Menu</button>
    </div>

    <button class="btn btn-f" onclick="window.addFood()">üíæ AJOUTER AU STOCK</button>
</div>

<div id="foodList"></div>

<script>
    // --- VARIABLES CL√âS ---
    window.myDb = [];
    window.myStats = { eaten: 0, wasted: 0, money: 0, co2: 0 };
    window.currentZone = 'Frigo';
    window.scannerObj = null;
    window.chartObj = null;

    // --- FONCTIONS CONNECT√âES AU SYST√àME ---
    window.switchZone = function(zone) {
        window.currentZone = zone;
        document.querySelectorAll('.tab-btn').forEach(function(btn) { btn.classList.remove('active'); });
        document.getElementById('btn' + zone).classList.add('active');
        window.renderList();
    };

    window.startCamera = function() {
        document.getElementById('btnStartCam').style.display = 'none';
        document.getElementById('reader').style.display = 'block';

        if (!window.scannerObj) {
            window.scannerObj = new Html5Qrcode("reader");
        }

        window.scannerObj.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: 250 },
            function(decodedText) {
                document.getElementById('foodName').value = "Recherche...";
                fetch("https://world.openfoodfacts.org/api/v0/product/" + decodedText + ".json")
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    if(data.status === 1) {
                        document.getElementById('foodName').value = data.product.product_name;
                    } else {
                        document.getElementById('foodName').value = decodedText;
                    }
                }).catch(function() { document.getElementById('foodName').value = decodedText; });
            },
            function(error) { /* Ignore background scan errors */ }
        ).catch(function(err) {
            alert("Impossible d'allumer la cam√©ra. V√©rifiez vos autorisations.");
            document.getElementById('btnStartCam').style.display = 'block';
            document.getElementById('reader').style.display = 'none';
        });
    };

    window.addFood = function() {
        var name = document.getElementById('foodName').value;
        var date = document.getElementById('expiryDate').value;
        if (!name || !date) { alert("Le nom et la date sont requis !"); return; }

        window.myDb.push({ id: Date.now(), name: name, date: date, zone: window.currentZone });
        window.saveData();
        
        document.getElementById('foodName').value = "";
        document.getElementById('expiryDate').value = "";
        window.renderList();
    };

    window.processFood = function(id, isEaten) {
        var index = window.myDb.findIndex(function(item) { return item.id === id; });
        if(index > -1) {
            if(isEaten) {
                window.myStats.eaten++;
                window.myStats.money += 3.5;
                window.myStats.co2 += 1.2;
            } else {
                window.myStats.wasted++;
            }
            window.myDb.splice(index, 1);
            window.saveData();
            window.renderList();
        }
    };

    window.askSub = function() {
        var name = document.getElementById('foodName').value.toLowerCase();
        if(!name) { alert("Tape un nom d'aliment d'abord !"); return; }
        alert("ü§ñ Je cherche un substitut pour : " + name + "\n(Essaie un produit de base comme du lait ou un oeuf !)");
    };

    window.askMenu = function() {
        var items = window.myDb.filter(function(i) { return i.zone === window.currentZone; }).slice(0, 2);
        if(items.length >= 2) { alert("üë®‚Äçüç≥ Cuisinons ! M√©lange ton " + items[0].name + " avec ton " + items[1].name + " !"); }
        else { alert("üë®‚Äçüç≥ Ajoute au moins 2 aliments dans cette zone."); }
    };

    window.saveData = function() {
        localStorage.setItem('v19_db', JSON.stringify(window.myDb));
        localStorage.setItem('v19_stats', JSON.stringify(window.myStats));
    };

    window.renderList = function() {
        var listDiv = document.getElementById('foodList');
        listDiv.innerHTML = "";
        var filtered = window.myDb.filter(function(item) { return item.zone === window.currentZone; });

        document.getElementById('statMoney').innerText = window.myStats.money.toFixed(1);
        document.getElementById('statCo2').innerText = window.myStats.co2.toFixed(1);
        
        if(window.chartObj) {
            window.chartObj.data.datasets[0].data = [window.myStats.eaten || 1, window.myStats.wasted || 0];
            window.chartObj.update();
        }

        if (filtered.length === 0) {
            listDiv.innerHTML = "<p style='text-align:center; color:#999; margin-top:20px;'>Rien dans : " + window.currentZone + "</p>";
            return;
        }

        filtered.sort(function(a,b) { return new Date(a.date) - new Date(b.date); }).forEach(function(item) {
            var daysLeft = Math.ceil((new Date(item.date) - new Date()) / 86400000);
            var borderColor = daysLeft < 0 ? "#ff7675" : (daysLeft < 3 ? "#fdcb6e" : "#2ed573");

            listDiv.innerHTML += `
                <div class="food-item" style="border-left-color: ${borderColor}">
                    <div style="flex-grow: 1;">
                        <b>${item.name}</b><br>
                        <small style="color:#666;">DLC: ${item.date} (${daysLeft < 0 ? 'P√©rim√©' : 'J-' + daysLeft})</small>
                    </div>
                    <div>
                        <button onclick="window.processFood(${item.id}, false)" style="background:none; border:none; font-size:22px;">üóëÔ∏è</button>
                        <button onclick="window.processFood(${item.id}, true)" style="background:none; border:none; font-size:22px;">‚úÖ</button>
                    </div>
                </div>
            `;
        });
    };

    // --- INITIALISATION AU D√âMARRAGE ---
    window.initApp = function() {
        try {
            window.myDb = JSON.parse(localStorage.getItem('v19_db')) || [];
            window.myStats = JSON.parse(localStorage.getItem('v19_stats')) || { eaten: 0, wasted: 0, money: 0, co2: 0 };
        } catch(e) { console.log("Init erreur", e); }

        try {
            var ctx = document.getElementById('mainChart');
            if (ctx && typeof Chart !== 'undefined') {
                window.chartObj = new Chart(ctx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Mang√©', 'Jet√©'],
                        datasets: [{
                            data: [window.myStats.eaten || 1, window.myStats.wasted || 0],
                            backgroundColor: ['#2ed573', '#ff7675'],
                            borderWidth: 0
                        }]
                    },
                    options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
            }
        } catch(e) { console.log("Chart err", e); }

        window.renderList();
        
        // Tout va bien : on passe la banni√®re au vert
        var status = document.getElementById('appStatus');
        status.style.background = '#2ed573';
        status.innerText = '‚úÖ Application connect√©e et pr√™te !';
    };

    // Lancement avec un petit d√©lai pour s'assurer que le t√©l√©phone a tout charg√©
    setTimeout(window.initApp, 500);

</script>
</body>
</html>

